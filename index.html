<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>STEEM smartvotes voter page</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="vendor/bootstrap/bootstrap-4.0.0.min.css"
          integrity="sha384-5iL/Lw9kHhhsgblb3am4cdovaFgONP7lxc4wh5a3qvq+X7NT+OlGQG29pKGZ2rzr"/>

    <style type="text/css">
        .octicon {
            height: 1rem;
        }

        footer {
            border-top: 1px solid #777;
        }
    </style>

</head>
<body class="bg-light">

<div class="container">
    <div class="py-5 text-center">
        <img class="d-block mx-auto mb-4" src="img/steem-logo.svg" alt="" width="100" height="100">
        <h1 class="display-3 text-muted">steem<wbr /> smart<wbr />votes</h1>
        <p class="lead">A smart tool that allows you to easily vote on behalf of your delegator. Put your posting key,
            type a delegator's username and paste steemit link. Voila! </p>
        <hr class="mb-4">
    </div>

    <div class="row">
        <div class="col-md-12">
            <span id="flash-messages"></span>

            <form class="needs-validation" novalidate>
                <div class="row">
                    <div class="col-md-6 mb-4">
                        
                        <label for="voter-username"><span class="text-small text-muted">1.</span> Your (voter) STEEM Username</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text"><img src="vendor/octicons/svg/person.svg" class="octicon" alt="User icon"/></span>
                            </div>
                            <div class="invalid-feedback" style="width: 100%;">
                                Your username is required.
                            </div>
                            <input type="text" class="form-control" id="voter-username" placeholder="Voter username" required>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <label for="delegator-username"><span class="text-small text-muted">2.</span> Delegator username</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text"><img src="vendor/octicons/svg/mortar-board.svg" class="octicon" alt="Delegator icon"/></span>
                            </div>
                            <div class="invalid-feedback" style="width: 100%;">
                                Delegator username is required.
                            </div>
                            <input type="text" class="form-control" id="delegator-username" placeholder="Delegator username" required>
                        </div>
                    </div>
                </div>

                <div class="mb-4"><br /></div>

                <div class="row">
                        <div class="col-md-10 offset-md-1 mb-4 ma-4">
                            <div class="text-center">
                                    <button type="button" class="btn btn-primary" id="load-rulesets-btn" disabled>Load rulesets</button>
                            </div><br/>
                            <div id="rules-panel">
                                <div class="alert alert-secondary">
                                    3. Please specify your username, your delegator username and 
                                    click &quot;Load rulesets&quot; button. Then select ruleset.
                                </div>
                            </div>
                        </div>
                </div>

                <div class="mb-4"><br /><br /></div>
                <div class="row">
                    <div class="col-md-12 mb-2">
                        <label for="post-slug"><span class="text-small text-muted">4.</span> Post slug (or link to the post on steemit)</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text"><img src="img/steem-logo.svg" class="octicon" alt="Steem logo icon" /></span>
                            </div>
                            <div class="invalid-feedback" style="width: 100%;">
                                Link to steemit or slug is required
                            </div>
                            <input type="text" class="form-control" id="post-slug" placeholder="category/@user/post-title-permlink" required disabled>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <label for="vote-weight">Vote weight</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text"><img src="vendor/octicons/svg/law.svg" class="octicon" alt="Vote weight icon"/></span>
                            </div>
                            <input type="text" class="form-control" id="vote-weight" placeholder="10000" required disabled>
                        </div>
                    </div>
                    <div class="col-md-6 mb-2">
                            <br />
                            <div class="d-block">
                                <div class="form-check form-check-inline mb-4">
                                    <input class="form-check-input" type="radio" name="voteorder-mode" id="voteorder-mode-upvote" value="upvote" checked disabled>
                                    <label class="form-check-label" for="voteorder-mode-upvote">Send upvote</label>
                                </div>
                                <div class="form-check form-check-inline mb-4">
                                    <input class="form-check-input" type="radio" name="voteorder-mode" id="voteorder-mode-flag" value="flag" disabled>
                                    <label class="form-check-label" for="voteorder-mode-flag">Send flag</label>
                                </div>
                            </div>
                        </div>
                </div>

                <div class="mb-2"><br /></div>

                <div class="row">
                    <div class="col-md-6 mb-6">
                            <label for="posting-key"><span class="text-small text-muted">5.</span> Your (voter) posting key WIF</label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><img src="vendor/octicons/svg/key.svg" class="octicon" alt="Key icon" /></span>
                                </div>
                                <div class="invalid-feedback" style="width: 100%;">
                                    Your posting key is required.
                                </div>
                                <input type="password" class="form-control" id="posting-key" placeholder="&bull;&bull;&bull;" required disabled>
                            </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        &nbsp;
                    </div>
                </div>

                <div class="mb-4"></div>
                <div class="row">
                    <div class="col-md-12 mb-4">
                            <button class="btn btn-primary btn-lg btn-block" id="send-btn" type="submit" disabled>Send to blockchain</button>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div id="final-message"></div>
                    </div>
                </div>
            </form>

            <br /><br />

            <br />
        </div>
    </div>

    <footer class="my-5 pt-3 mt-4 text-muted text-center text-small">
        <strong>More info</strong> / star / fork on
        <a href="https://github.com/noisy-witness/steem-smartvotes-core" class="btn btn-outline-secondary">
            <img src="vendor/octicons/svg/mark-github.svg" class="octicon" style="margin-bottom: 3px;" alt="Github logo" /> /noisy-witness/steem-smartvotes-core
        </a>
        <p> </p>
        <p style="font-size: 0.75rem;">
            Source of this page: <a href="https://github.com/noisy-witness/steem-smartvotes-voter-page">github.com/noisy-witness/steem-smartvotes-voter-page</a>. <br />
            &copy; 2018-2018 by [pending]. LICENSE under discussion. Unlicensed till decision.
        </p>
    </footer>
</div>

<script src="vendor/jquery/jquery-3.3.1.min.js"
        integrity="sha384-tsQFqpEReu7ZLhBV2VZlAu7zcOV+rXbYlF2cqB8txI/8aZajjp4Bqd+V6D5IgvKT"></script>
<script src="vendor/bootstrap/bootstrap-4.0.0.min.js"
        integrity="sha384-hELc4MRmolvcDvuzl/3FNNU/J6iZrg9KjhNCuUJWtpClnHeJA4yID0ul8/pMrRxJ"></script>
<script src="smartvotes-lib/steem-smartvotes.min.js"></script>
<!-- There is no integrity sum, because the library is still in it's early development phase.
It is a TODO to add integrity check for steem-smartvotes.min.js to voter-page. -->

<script type="text/javascript">
    function putFlashMessage(msg, cssClass) {
        $("#flash-messages").append("<div class=\"alert alert-"+cssClass+" mb-4\">"+msg+"</div>");
    }

    function checkIfSmartvotesPresent() {
        if(typeof(steemsmartvotes) === 'undefined') {
            console.error("Steem-smartvotes lib is not present.");
            putFlashMessage("Steem-smartvotes lib is not present.", "danger");
        }
    }

    function setupInputEvents() {
        $("#voter-username, #delegator-username").keyup(function(evt) {
            if($("#voter-username").val().length > 0 && $("#delegator-username").val().length) {
                $("#load-rulesets-btn").prop('disabled', false);
            }
            else {
                $("#load-rulesets-btn").prop('disabled', true);
            }
        });

        $("#load-rulesets-btn").click(function() {
            loadRulesets();
        });

        $("#post-slug").change(function() {
            validateSteemPost();
        });

        $("#send-btn").click(function() {
            //sendSmartvote();
        });
    }

    function loadRulesets() {
        var voterUsername = $("#voter-username").val();
        var delegatorUsername = $("#delegator-username").val();
        if(voterUsername.length == 0 || delegatorUsername.length == 0) {
            console.error("Before loading rulesets you must specify voter username and delegator username.");
            $("#rules-panel").html("<div class=\"alert alert-danger mb-4\">Before loading rulesets you must specify voter username and delegator username.</div>");
        }
        else {
            $("#rules-panel").html("<div class=\"alert alert-info mb-4\">Loading rulesets... Please wait.</div>");
            steemsmartvotes.SteemSmartvotes.getRulesetsOfUser(delegatorUsername, new Date(), function(error, result) {
                if(error) {
                    $("#rules-panel").html("<div class=\"alert alert-danger mb-4\">Error when loading rulesets: "+error.message+"</div>");
                }
                else {
                    if(result.length === 0) {
                        $("#rules-panel").html("<div class=\"alert alert-warning mb-4\">This delegator does not exist or did not set any smartvote rules.</div>");
                    }
                    else {
                        var myRules = [];
                        for(var i in result) {
                            var rule = result[i];
                            if(rule.voter == voterUsername) myRules.push(rule);
                        }
                        if(myRules.length == 0) {
                            $("#rules-panel").html("<div class=\"alert alert-warning mb-4\">This delegator did not set any smartvote rules for this voter.</div>");
                        }
                        else {
                            showRulesets(myRules);
                        }
                    }
                }
            });
        }
    }

    function showRulesets(rulesets) {
        var rulesHtml = "";
        for(var i in rulesets) {
            var ruleset = rulesets[i];
            rulesHtml += "<div class=\"card\"><div class=\"card-body\">"
                + "<h5 class=\"card-title\">"+ruleset.name+"</h5><pre class=\"card-text\" style=\"font-size: 50%;\">"+JSON.stringify(ruleset, null, 2)+"</pre>"
                + "<div class=\"form-check\">"
                + "   <input style=\"padding-left: 1rem;\" class=\"form-check-input\" type=\"radio\" name=\"ruleset-selector\" id=\"ruleset-selector-"+i+"\" value=\""+ruleset.name+"\" " + (i == 0? "checked" : "") + ">"
                + "   <label class=\"form-check-label\" for=\"ruleset-selector-"+i+"\">Select this ruleset</label>"
                + "</div>"
                + "</div></div><br />";
        }
    
        $("#rules-panel").html("<div>" + rulesHtml + "</div>");
        enableLastPanel();
    }

    function enableLastPanel() {
        $("#post-slug").prop('disabled', false);
        $("input:radio[name='voteorder-mode']").prop('disabled', false);
        $("#posting-key").prop('disabled', false);
        $("#send-btn").prop('disabled', false);
        $("#vote-weight").prop('disabled', false);
    }

    function validateSteemPost() {
        var voterUsername = $("#voter-username").val();
        try {
            $("#final-message").html("<div class=\"alert alert-info\">Validating your voteorder...</div>");
            var voteorder = constructVoteorder();
            steemsmartvotes.SteemSmartvotes.validateVoteOrder(voterUsername, voteorder, new Date(), function(error, result) {
                if(error) {
                    $("#final-message").html("<div class=\"alert alert-danger\">"+error.message+"</div>");
                    console.error(error);
                }
                else {
                    $("#final-message").html("<div class=\"alert alert-info\">Your message is valid. You can now send it.</div>");
                    console.log("Success!");
                }
            });
            console.log(voteorder);
        }
        catch(err) {
            $("#final-message").html("<div class=\"alert alert-danger\">"+err.message+"</div>");
            console.error(err);
        }
    }

    function constructVoteorder() {
        // TODO validate below values
        var voter = $("#voter-username").val();
        var delegator = $("#delegator-username").val();
        var weight = $("#vote-weight").val();
        var type = $("input:radio[name='voteorder-mode']:checked").val();
        var rulesetName = $("input:radio[name='ruleset-selector']:checked").val();
        
        var slug = $("#post-slug").val();
        if(slug.length === 0) throw new Error("Slug cannot be empty.");
        var regex = /^(?:(?:https?:\/\/steemit\.com)?\/(?:[^/]*)\/@)?([^\/]+)\/([^\/]+)$/giu;
        var match = regex.exec(slug);
        if(regex.length < 3) {
            throw new Error("Wrong format. Please paste steemit link, or <category>?/@user/@permlink.");
        }
        var author = match[1];
        var permlink = match[2];

        return {
            ruleset_name: rulesetName,
            author: author,
            permlink: permlink,
            delegator: delegator,
            weight: weight,
            type: type
        };
    }

    $(document).ready(function() {
        checkIfSmartvotesPresent();
        setupInputEvents();
    });
</script>
</body>
</html>